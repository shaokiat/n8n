# render.yaml
# Infrastructure definition for AI Meal Plan Assistant using n8n + Supabase

services:
  - type: web
    name: mealgpt-n8n
    env: docker
    plan: free
    region: singapore
    dockerfilePath: ./Dockerfile
    autoDeploy: false

    envVars:
      # === Database connection (Supabase) ===
      - key: DB_TYPE
        value: postgresdb
      - key: DB_POSTGRESDB_HOST
        value: aws-1-ap-southeast-1.pooler.supabase.com
      - key: DB_POSTGRESDB_PORT
        value: 5432
      - key: DB_POSTGRESDB_DATABASE
        value: postgres
      - key: DB_POSTGRESDB_USER
        value: postgres.wrcmwqozlscnaarqztuf
      - key: DB_POSTGRESDB_PASSWORD
        sync: false # set manually in Render dashboard
      - key: DB_POSTGRESDB_SSL_CA
        value: /etc/ssl/certs/ca-certificates.crt

      # === Authentication for n8n dashboard ===
      - key: N8N_BASIC_AUTH_ACTIVE
        value: "true"
      - key: N8N_BASIC_AUTH_USER
        value: admin
      - key: N8N_BASIC_AUTH_PASSWORD
        sync: false
      - key: N8N_ENCRYPTION_KEY
        sync: false

      # === AI & Telegram Integrations ===
      - key: OPENAI_API_KEY
        sync: false
      - key: TELEGRAM_BOT_TOKEN
        sync: false
      - key: TELEGRAM_CHAT_ID
        sync: false

      # === n8n runtime configuration ===
      - key: WEBHOOK_URL
        value: https://n8n-service-me23.onrender.com
      - key: GENERIC_TIMEZONE
        value: Asia/Singapore
      - key: EXECUTIONS_PROCESS
        value: own
      - key: EXECUTIONS_DATA_PRUNE
        value: "true"
      - key: EXECUTIONS_DATA_MAX_AGE
        value: 336 # hours (2 weeks)
      - key: N8N_METRICS
        value: "false"

    healthCheckPath: /
    buildCommand: ""
    startCommand: "n8n start"
