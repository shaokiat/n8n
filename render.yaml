# render.yaml
# Infrastructure definition for AI Meal Plan Assistant using n8n + Supabase

services:
  - type: web
    name: mealgpt-n8n
    plan: free
    region: singapore
    runtime: image
    image:
      # Pulls the n8n image tagged as latest from Docker Hub
      url: docker.io/n8nio/n8n:latest
    envVars:
      # Generates a base64-encoded key for
      # encrypting credentials in n8n
      #
      # Do not modify this value after it's generated!
      # If you do, you'll lose access to all credentials
      # encrypted with the previous value.
      - key: N8N_ENCRYPTION_KEY
        generateValue: true

      - key: WEBHOOK_URL
        value: "https://mealgpt-n8n.onrender.com"

      # === Database connection (Supabase) ===
      - key: DB_TYPE
        value: postgresdb
      - key: DB_POSTGRESDB_HOST
        value: aws-1-ap-southeast-1.pooler.supabase.com
      - key: DB_POSTGRESDB_PORT
        value: 5432
      - key: DB_POSTGRESDB_DATABASE
        value: postgres
      - key: DB_POSTGRESDB_USER
        value: postgres.wrcmwqozlscnaarqztuf
      - key: DB_POSTGRESDB_PASSWORD
        sync: false # set manually in Render dashboard
      - key: DB_POSTGRESDB_SSL
        value: "true"
      - key: DB_POSTGRESDB_SSL_REJECT_UNAUTHORIZED
        value: "false"

      # === Authentication for n8n dashboard ===
      - key: N8N_BASIC_AUTH_ACTIVE
        value: "true"
      - key: N8N_BASIC_AUTH_USER
        value: admin
      - key: N8N_BASIC_AUTH_PASSWORD
        sync: false
      - key: N8N_ENCRYPTION_KEY
        sync: false

      # === AI & Telegram Integrations ===
      - key: OPENAI_API_KEY
        sync: false
      - key: TELEGRAM_BOT_TOKEN
        sync: false
      - key: TELEGRAM_CHAT_ID
        sync: false

      # === n8n runtime configuration ===
      - key: WEBHOOK_URL
        value: https://mealgpt-n8n.onrender.com
      - key: GENERIC_TIMEZONE
        value: Asia/Singapore
      - key: EXECUTIONS_PROCESS
        value: own
      - key: EXECUTIONS_DATA_PRUNE
        value: "true"
      - key: EXECUTIONS_DATA_MAX_AGE
        value: 336 # hours (2 weeks)
      - key: N8N_METRICS
        value: "false"
    healthCheckPath: /
